<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>File-Upload</title>

    <link href="/webjars/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <script src="/webjars/jquery/2.2.3/jquery.min.js"></script>
    <script src="/webjars/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="/webjars/momentjs/2.12.0/moment.js"></script>
    <script type="text/javascript">
    
    var upload = function()
    {
        var uploadFormData = new FormData();
        // man kann mehrere file input Felder anhängen, aber auf Serverseite
        // gibt es nur eine Content-Length, für die Größe der HTTP-Nachricht
        uploadFormData.append("file", $("#uploadFile").get(0).files[0]);

        $.ajax(
        {
          url: "/upstream",
          type: "POST",
          data: uploadFormData,
          async: true,
          contentType: false,
          processData: false
        });
    };

    var formatBytes = function (bytes)
    {
        if(bytes == 0) return '0 Byte';
        var k = 1024;
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(3)) + '\u00a0' + sizes[i];
    }

    var getStatusLine = function(fileName)
    {
        var statusLine = $(document.getElementsByName(fileName)[0]);

        if (typeof(statusLine.get(0)) !== "undefined") return statusLine;
      
        var progressBar =
            $("<div>", {class : "progress"})
            .append($("<div>", 
            {
                class : "progress-bar",
                role : "progressbar",
                style : "min-width: 2em; width: 0%"
            }).text("0%"));

        statusLine = 
            $("<tr>").attr("name", fileName)
            .append($("<td>").attr("name", "state"))
            .append($("<td>").text(fileName))
            .append($("<td>").attr("name", "progress").append(progressBar))
            .append($("<td>").attr("name", "size"))
            .append($("<td>").attr("name", "elapsedTime"))
            .append($("<td>").attr("name", "remainingTime"));

        $("#statusTable tbody").append(statusLine);

        return statusLine;
    };

    var setProgress = function(statusLine, fileStatus)
    {
        var progress = fileStatus.runningState ? Math.round((fileStatus.count * 100) / fileStatus.contentLength) : 100;
        var progressBar = statusLine.find(".progress-bar");
        progressBar.text(progress + "%");
        progressBar.attr("style", "min-width: 2em; width:" + progress + "%");
    };

    var refreshStatus = function(status)
    {
        for (var fileName in status)
        {
          var fileStatus = status[fileName];
          var statusLine = getStatusLine(fileName);

          statusLine.find("td[name='size']").text(formatBytes(fileStatus.contentLength));
          statusLine.find("td[name='state']").text(fileStatus.runningState);
          statusLine.find("td[name='elapsedTime']").text(moment(fileStatus.startTime).format("YYYY-MM-DD HH:mm:ss"));
          setProgress(statusLine, fileStatus);
        }
        window.setTimeout(function(){$.ajax({url: "/status", success: refreshStatus});}, 1000);
    }

    $(document).ready(function()
    {
        $("#uploadButton").click(upload);
        $.ajax({url: "/status", success: refreshStatus});
    });

    </script>
</head>

<body>
    <input id="uploadFile" type="file">
    <button id="uploadButton">Upload</button>
    <button id="resetButton" onclick="$.ajax({url: '/reset'});">Reset</button>
    <table id="statusTable" class="table table-bordered">
        <thead>
            <tr>
                <th width="4%">State</th>
                <th width="23%">Name</th>
                <th width="23%">Progress</th>
                <th width="4%">Size</th>
                <th width="23%">Elapsed Time</th>
                <th width="23%">Remaining Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</body>
</html>