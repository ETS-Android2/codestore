<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>File-Upload</title>

    <link href="/webjars/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <script src="/webjars/jquery/2.2.3/jquery.min.js"></script>
    <script src="/webjars/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript">
    
    var upload = function()
    {
        var uploadFormData = new FormData();
        // man kann mehrere file input Felder anhängen, aber auf Serverseite
        // gibt es nur eine Content-Length, für die Größe der HTTP-Nachricht
        uploadFormData.append("file", $("#uploadFile").get(0).files[0]);

        $.ajax(
        {
          url: "/upstream",
          type: "POST",
          data: uploadFormData,
          async: true,
          contentType: false,
          processData: false
        });
    };

    var getStatusLine = function(fileName)
    {
        var statusLine = $(document.getElementsByName(fileName)[0]);

        if (typeof(statusLine.get(0)) !== "undefined") return statusLine;
      
        var progressBar =
            $("<div>", {class : "progress"})
            .append($("<div>", 
            {
                class : "progress-bar",
                role : "progressbar",
                style : "min-width: 2em; width: 0%"
            }).text("0%"));

        statusLine = 
            $("<tr>").attr("name", fileName)
            .append($("<td>").text(fileName))
            .append($("<td>").attr("name", "contentLength"))
            .append($("<td>").attr("name", "count").append(progressBar))
            .append($("<td>").attr("name", "runningState"))
            .append($("<td>").attr("name", "startTime"));

        $("#statusTable tbody").append(statusLine);

        return statusLine;
    };

    var setProgress = function(statusLine, fileStatus)
    {
        var progress = fileStatus.runningState ? Math.round((fileStatus.count * 100) / fileStatus.contentLength) : 100;
        var progressBar = statusLine.find(".progress-bar");
        progressBar.text(progress + "%");
        progressBar.attr("style", "min-width: 2em; width:" + progress + "%");
    };

    var refreshStatus = function(status)
    {
        for (var fileName in status)
        {
          var fileStatus = status[fileName];
          var statusLine = getStatusLine(fileName);

          statusLine.find("td[name='contentLength']").text(fileStatus.contentLength);
          statusLine.find("td[name='runningState']").text(fileStatus.runningState);
          statusLine.find("td[name='startTime']").text(fileStatus.startTime);
          setProgress(statusLine, fileStatus);
        }
        window.setTimeout(function(){$.ajax({url: "/status", success: refreshStatus});}, 1000);
    }

    $(document).ready(function()
    {
        $("#uploadButton").click(upload);
        $.ajax({url: "/status", success: refreshStatus});
    });

    </script>
</head>

<body>
    <input id="uploadFile" type="file">
    <button id="uploadButton">Upload</button>
    <button id="resetButton" onclick="$.ajax({url: '/reset'});">Reset</button>
    <table id="statusTable" class="table"><tbody></tbody></table>
</body>
</html>